#!/bin/bash
# 09-uefi-pxe-setup.sh
# Add UEFI PXE boot support to existing PXE server

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source configuration if it exists
if [[ -f "$SCRIPT_DIR/config.sh" ]]; then
    source "$SCRIPT_DIR/config.sh"
else
    echo -e "${RED}Error: config.sh not found.${NC}"
    echo "Please ensure PXE server is configured first."
    exit 1
fi

echo "=== Adding UEFI PXE Boot Support ==="

# Function to check if running as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}Error: This script must be run as root or with sudo${NC}"
        exit 1
    fi
}

# Function to setup UEFI boot files
setup_uefi_boot_files() {
    echo -e "${BLUE}Setting up UEFI boot files...${NC}"
    
    # Create EFI directory structure
    echo -n "Creating EFI directory structure... "
    mkdir -p "$TFTP_ROOT/efi64"
    mkdir -p "$TFTP_ROOT/grub"
    echo -e "${GREEN}OK${NC}"
    
    # Copy GRUB EFI network boot file
    echo -n "Copying GRUB EFI network boot file... "
    if [[ -f "/usr/lib/grub/x86_64-efi-signed/grubnetx64.efi.signed" ]]; then
        cp "/usr/lib/grub/x86_64-efi-signed/grubnetx64.efi.signed" "$TFTP_ROOT/bootx64.efi"
    elif [[ -f "/usr/lib/grub/x86_64-efi/monolithic/grubnetx64.efi" ]]; then
        cp "/usr/lib/grub/x86_64-efi/monolithic/grubnetx64.efi" "$TFTP_ROOT/bootx64.efi"
    else
        echo -e "${RED}Failed${NC}"
        echo "Error: GRUB EFI network boot file not found"
        return 1
    fi
    echo -e "${GREEN}OK${NC}"
    
    # Set proper ownership
    echo -n "Setting file ownership... "
    chown -R tftp:tftp "$TFTP_ROOT/efi64" "$TFTP_ROOT/grub" "$TFTP_ROOT/bootx64.efi"
    chmod 644 "$TFTP_ROOT/bootx64.efi"
    echo -e "${GREEN}OK${NC}"
}

# Function to create GRUB configuration using GRUB tools
create_grub_config() {
    echo -e "${BLUE}Creating GRUB configuration using GRUB tools...${NC}"
    
    # Use the new GRUB configuration generator
    local grub_generator="$SCRIPT_DIR/grub-pxe-config-generator.sh"
    
    if [[ -f "$grub_generator" ]]; then
        echo -n "Generating GRUB configuration with grub-mkconfig integration... "
        if "$grub_generator" install; then
            echo -e "${GREEN}OK${NC}"
        else
            echo -e "${YELLOW}Failed, using fallback method${NC}"
            create_grub_config_fallback
        fi
    else
        echo -e "${YELLOW}GRUB generator not found, using fallback method${NC}"
        create_grub_config_fallback
    fi
}

# Fallback function for manual GRUB configuration creation
create_grub_config_fallback() {
    echo -n "Creating grub.cfg (fallback method)... "
    cat > "$TFTP_ROOT/grub/grub.cfg" << EOF
# GRUB Configuration for UEFI PXE Boot
# Generated by PXE Server Setup Script (Fallback Method)
# Server: $PXE_SERVER_IP

set timeout=30
set default=0

# Load required modules for network PXE boot
insmod part_gpt
insmod part_msdos
insmod fat
insmod ext2
insmod net
insmod efinet
insmod tftp
insmod http
insmod chain
insmod linux
insmod multiboot
insmod multiboot2

# Set network configuration
set net_default_server=$PXE_SERVER_IP
set root=(tftp,$PXE_SERVER_IP)

# Network initialization
net_add_addr \$net_default_mac ipv4 dhcp

menuentry 'Boot from local disk' --id=local {
    # Try to boot from local disk
    search --no-floppy --set=root --label /
    if [ -f /EFI/BOOT/BOOTX64.EFI ]; then
        chainloader /EFI/BOOT/BOOTX64.EFI
    elif [ -f /EFI/Microsoft/Boot/bootmgfw.efi ]; then
        chainloader /EFI/Microsoft/Boot/bootmgfw.efi
    else
        # Fallback to first hard drive
        set root=(hd0)
        chainloader +1
    fi
    boot
}

menuentry 'Memory Test (EFI)' --id=memtest {
    if [ -f /tools/memtest86.efi ]; then
        chainloader /tools/memtest86.efi
    else
        echo "EFI Memory test not available"
        echo "Press any key to return to menu..."
        read
    fi
}

# Dynamic ISO entries will be populated by grub-pxe-config-generator.sh
# when ISOs are added using the iso-manager script

menuentry 'BIOS PXE Menu (Legacy)' --id=legacy {
    echo 'Switching to legacy BIOS PXE menu...'
    echo 'Restart with Legacy/BIOS mode for full menu'
    echo 'Press any key to continue...'
    read
}

menuentry 'Network Information' --id=netinfo {
    echo "Network Configuration:"
    echo "PXE Server: $PXE_SERVER_IP"
    echo "Interface: \$net_default_mac"
    echo ""
    echo "Available boot options are shown in main menu"
    echo "Press any key to return to menu..."
    read
}

menuentry 'Reboot' --id=reboot {
    reboot
}

menuentry 'Shutdown' --id=shutdown {
    halt
}
EOF
    
    chown tftp:tftp "$TFTP_ROOT/grub/grub.cfg"
    chmod 644 "$TFTP_ROOT/grub/grub.cfg"
    echo -e "${GREEN}OK${NC}"
}

# Function to update DHCP configuration for UEFI support
update_dhcp_config() {
    echo -e "${BLUE}Updating DHCP configuration for UEFI support...${NC}"
    
    # Backup current DHCP config
    echo -n "Backing up DHCP configuration... "
    cp /etc/dhcp/dhcpd.conf "/etc/dhcp/dhcpd.conf.backup.$(date +%Y%m%d_%H%M%S)"
    echo -e "${GREEN}OK${NC}"
    
    # Update DHCP config to support both BIOS and UEFI
    echo -n "Adding UEFI PXE support to DHCP... "
    
    # Add UEFI detection and boot file selection to DHCP config
    cat >> /etc/dhcp/dhcpd.conf << 'EOF'

# UEFI PXE Boot Support
# Detect client architecture and provide appropriate boot file
option arch code 93 = unsigned integer 16;

class "pxeclients" {
  match if substring (option vendor-class-identifier, 0, 9) = "PXEClient";
  if option arch = 00:07 {
    # x86_64 UEFI
    filename "bootx64.efi";
  } else if option arch = 00:09 {
    # x86_64 UEFI alternative
    filename "bootx64.efi";
  } else if option arch = 00:0b {
    # aarch64 UEFI
    filename "bootaa64.efi";
  } else {
    # Legacy BIOS (default)
    filename "pxelinux.0";
  }
}
EOF
    
    echo -e "${GREEN}OK${NC}"
    
    # Test DHCP configuration
    echo -n "Testing DHCP configuration... "
    if dhcpd -t -cf /etc/dhcp/dhcpd.conf; then
        echo -e "${GREEN}Valid${NC}"
    else
        echo -e "${RED}Invalid${NC}"
        echo "Restoring backup..."
        cp "/etc/dhcp/dhcpd.conf.backup.$(date +%Y%m%d_%H%M%S)" /etc/dhcp/dhcpd.conf
        return 1
    fi
}

# Function to restart services
restart_services() {
    echo -e "${BLUE}Restarting services...${NC}"
    
    echo -n "Restarting TFTP service... "
    if systemctl restart tftpd-hpa; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}Failed${NC}"
    fi
    
    echo -n "Restarting DHCP service... "
    if systemctl restart isc-dhcp-server; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}Failed${NC}"
    fi
}

# Function to verify setup
verify_uefi_setup() {
    echo -e "${BLUE}Verifying UEFI PXE setup...${NC}"
    
    # Check UEFI boot file
    echo -n "Checking UEFI boot file... "
    if [[ -f "$TFTP_ROOT/bootx64.efi" ]]; then
        echo -e "${GREEN}Present${NC}"
    else
        echo -e "${RED}Missing${NC}"
        return 1
    fi
    
    # Check GRUB config
    echo -n "Checking GRUB configuration... "
    if [[ -f "$TFTP_ROOT/grub/grub.cfg" ]]; then
        echo -e "${GREEN}Present${NC}"
    else
        echo -e "${RED}Missing${NC}"
        return 1
    fi
    
    # Check service status
    echo -n "Checking TFTP service... "
    if systemctl is-active tftpd-hpa >/dev/null 2>&1; then
        echo -e "${GREEN}Running${NC}"
    else
        echo -e "${RED}Stopped${NC}"
    fi
    
    echo -n "Checking DHCP service... "
    if systemctl is-active isc-dhcp-server >/dev/null 2>&1; then
        echo -e "${GREEN}Running${NC}"
    else
        echo -e "${RED}Stopped${NC}"
    fi
}

# Function to show summary
show_summary() {
    echo
    echo -e "${GREEN}=== UEFI PXE Setup Complete ===${NC}"
    echo "Boot File Support:"
    echo "  • BIOS (Generation 1): pxelinux.0"
    echo "  • UEFI (Generation 2): bootx64.efi"
    echo
    echo "DHCP Configuration:"
    echo "  • Automatic client architecture detection"
    echo "  • Serves appropriate boot file based on client type"
    echo
    echo "GRUB Menu:"
    echo "  • $TFTP_ROOT/grub/grub.cfg"
    echo "  • Simplified UEFI menu with Ubuntu option"
    echo
    echo "Testing:"
    echo "  • Generation 1 VM: Will get BIOS PXE menu (pxelinux)"
    echo "  • Generation 2 VM: Will get UEFI GRUB menu"
    echo
    echo "Your Generation 2 VM should now boot successfully!"
}

# Main execution
main() {
    echo "Starting UEFI PXE boot configuration..."
    echo "Date: $(date)"
    echo "User: $(whoami)"
    echo "Host: $(hostname)"
    echo

    check_root
    setup_uefi_boot_files
    create_grub_config
    update_dhcp_config
    restart_services
    verify_uefi_setup
    show_summary
}

# Run main function
main "$@"
